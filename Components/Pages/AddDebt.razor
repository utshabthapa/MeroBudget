@page "/adddebt"
@using MeroBudget.Models
@inject UserService UserService

<div class="flex align-items-center h-100">

    <div style="width:600px;" class="mx-auto bg-white rounded-2xl p-6 my-auto">
        <h1 class="text-center font-bold text-2xl">Add Debt</h1>

        <EditForm Model="newDebt" OnValidSubmit="HandleDebtSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="text-red-600 font-semibold mb-4">@ErrorMessage</div>
            }

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1" for="amount">Debt Amount</label>
                <InputNumber class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="amount" @bind-Value="newDebt.Amount" placeholder="Enter amount" />
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1" for="dueDate">Due Date</label>
                <InputDate class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="dueDate" @bind-Value="newDebt.DueDate" required/>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1" for="tag">Tag</label>
                <InputText class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="tag" @bind-Value="newDebt.Tag" placeholder="Enter tag" />
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1" for="description">Description</label>
                <InputText class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" id="description" @bind-Value="newDebt.Description" placeholder="Enter description" />
            </div>

            <div class="text-center">
                <button type="submit" class="w-full bg-blue-500 text-white py-2  rounded-lg hover:bg-blue-600 focus:ring-4 focus:ring-blue-500 transition duration-200">Add Debt</button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    private AppData Data;
    private Debt newDebt = new Debt();
    private string ErrorMessage;


    protected override void OnInitialized()
    {
        Data = UserService.LoadData();
    }

    private void HandleDebtSubmit()
    {
        decimal totalDebt = Data.Debt.Sum(d => d.Amount);

        if (newDebt.PaidAmount> totalDebt)
        {
            ErrorMessage = "Clearing more debt than the total debt.";
            return;
        }
        newDebt.Id = Data.Debt.Count + 1;
        // If the date is not set (default value), use DateTime.Now
        newDebt.Date = newDebt.Date == default ? DateTime.Now : newDebt.Date;

        newDebt.DueDate = newDebt.DueDate == default ? DateTime.Now : newDebt.DueDate;
        Data.Debt.Add(newDebt);
        UserService.SaveData(Data);

        // Reset form
        newDebt = new Debt();
    }
}

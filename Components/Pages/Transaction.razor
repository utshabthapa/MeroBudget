@page "/transaction"
@using MeroBudget.Models
@inject UserService UserService
@inject IJSRuntime JSRuntime


<div class="bg-white p-6 rounded-2xl mt-12">
    <div class="flex justify-between items-center mb-6">
        <h1 class="font-bold text-3xl">User Transactions</h1>

        <div class="flex gap-8">
            <!-- Filter by Category -->
            <div>
                <label for="categoryFilter" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                <select id="categoryFilter" @onchange="FilterByCategory" class="border border-gray-300 rounded-lg px-4 py-2">
                    <option value="All">All</option>
                    <option value="Credit">Credit</option>
                    <option value="Debit">Debit</option>
                </select>
            </div>

            <!-- Filter by Tags -->
            <div>
                <label for="tagFilter" class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
                <select id="tagFilter" @onchange="FilterByTag" class="border border-gray-300 rounded-lg px-4 py-2">
                    <option value="All">All Tags</option>
                    @foreach (var tag in AvailableTags)
                    {
                        <option value="@tag">@tag</option>
                    }
                </select>
            </div>

            <!-- Filter by Date -->
            <div>
                <label for="dateFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Date</label>
                <select id="dateFilter" @onchange="FilterByDate" class="border border-gray-300 rounded-lg px-4 py-2">
                    <option value="All">All Time</option>
                    <option value="LastMonth">Last Month</option>
                    <option value="Last3Months">Last 3 Months</option>
                    <option value="SpecificRange">Specific Date Range</option>
                </select>
            </div>

            <!-- Specific Date Range -->
            @if (SelectedDateFilter == "SpecificRange")
            {
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                    <input type="date" @oninput="UpdateStartDate" class="border border-gray-300 rounded-lg px-4 py-2" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                    <input type="date" @oninput="UpdateEndDate" class="border border-gray-300 rounded-lg px-4 py-2" />
                </div>
            }

            <!-- Search -->
            <div>
                <label for="search" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                <input type="text"
                id="search"
                placeholder="Search..."
                @oninput="SearchTransactions"
                class="border border-gray-300 rounded-lg px-4 py-2 w-48" />
            </div>
        </div>
    </div>



    <!-- Summary Cards Section -->
    <div class="flex gap-6 mb-6">
        <!-- Main Balance -->
        <div class="bg-green-100 border border-green-300 rounded-lg p-4 flex-1">
            <h2 class="text-green-700 font-medium text-lg">Main Balance</h2>
            <p class="text-green-900 font-bold text-2xl">Rs.@MainBalance.ToString("")</p>
        </div>

        <!-- Total Transactions -->
        <div class="bg-blue-100 border border-blue-300 rounded-lg p-4 flex-1">
            <h2 class="text-blue-700 font-medium text-lg">Total Transactions</h2>
            <p class="text-blue-900 font-bold text-2xl">@FilteredTransactions.Count()</p>
        </div>
    </div>
    <div class="flex gap-6 mb-6">

        <!-- Highest Inflow -->
        <div class="bg-green-100 border border-green-300 rounded-lg p-4 flex-1">
            <h2 class="text-green-700 font-medium text-lg">Highest Inflow</h2>
            <p class="text-green-900 font-bold text-2xl">
                @(HighestInflowTransaction != null ? "Rs." : "Rs.")
                @if (HighestInflowTransaction != null)
                {
                    @HighestInflowTransaction.Credit.ToString("")
                }
                else
                {
                    <p>N / A</p>
                }
            </p>
        </div>

        <!-- Lowest Inflow -->
        <div class="bg-green-100 border border-green-300 rounded-lg p-4 flex-1">
            <h2 class="text-green-700 font-medium text-lg">Lowest Inflow</h2>
            <p class="text-green-900 font-bold text-2xl">
                @(LowestInflowTransaction != null ? "Rs." : "Rs.")

                @if (LowestInflowTransaction != null)
                {
                    @LowestInflowTransaction.Credit.ToString("")
                }
                else
                {
                    <p>N / A</p>
                }
            </p>
        </div>

        <!-- Highest Outflow -->
        <div class="bg-red-100 border border-red-300 rounded-lg p-4 flex-1">
            <h2 class="text-red-700 font-medium text-lg">Highest Outflow</h2>
            <p class="text-red-900 font-bold text-2xl">
                @(HighestOutflowTransaction != null ? "Rs." : "Rs.")

                @if (HighestOutflowTransaction != null)
                {
                    @HighestOutflowTransaction.Debit.ToString("")
                }
                else
                {
                    <p>N / A</p>
                }
            </p>
        </div>

        <!-- Lowest Outflow -->
        <div class="bg-red-100 border border-red-300 rounded-lg p-4 flex-1">
            <h2 class="text-red-700 font-medium text-lg">Lowest Outflow</h2>
            <p class="text-red-900 font-bold text-2xl">
                @(LowestOutflowTransaction != null ? "Rs." : "Rs.")

                @if (LowestOutflowTransaction != null)
                {
                    @LowestOutflowTransaction.Debit.ToString("")
                }
                else
                {
                    <p>N / A</p>
                }
            </p>
        </div>

    </div>

    <!-- Sorting Section -->
    <div class="flex justify-end gap-4 mb-4">
        <button @onclick="SortByLatest" class="bg-gray-200 text-black text-sm tracking-wide px-4 py-2 rounded-lg hover:bg-gray-300">Sort by Latest</button>
        <button @onclick="SortByOldest" class="bg-gray-200 text-black text-sm tracking-wide px-4 py-2 rounded-lg hover:bg-gray-300">Sort by Oldest</button>
        <div>
            <button @onclick="DownloadTransactionsAsExcel" class="bg-gray-800 text-white text-sm tracking-wide px-4 py-2 rounded-lg hover:bg-gray-900">
                Download as Excel
            </button>
        </div>
    </div>
    <!-- Transactions Table -->
    <div style="max-height: 400px;" class="w-full overflow-y-auto">

        <table class=" border-collapse border border-gray-300 w-full">
            <thead class="bg-gray-200">
                <tr>
                    <th class="px-4 py-2">Transaction ID</th>
                    <th class="px-4 py-2">Category</th>
                    <th class="px-4 py-2">Amount</th>
                    <th class="px-4 py-2">Date</th>
                    <th class="px-4 py-2">Source/Purpose</th>
                    <th class="px-4 py-2">Tags</th>
                    <th class="px-4 py-2">Additional Notes</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var transaction in FilteredTransactions)
                {
                    <tr>
                        <td class="border px-4 py-2">#TRNSC00-@transaction.Id</td>

                        <td class="border px-4 py-2">
                            @if (transaction.Credit > 0)
                            {
                                <span class="text-green-600">Credit</span>
                            }
                            else
                            {
                                <span class="text-red-600">Debit</span>
                            }
                        </td>
                        <td class="border px-4 py-2">
                            @if (transaction.Credit > 0)
                            {
                                <span class="text-green-600">Rs.@transaction.Credit.ToString("")</span>
                            }
                            else
                            {
                                <span class="text-red-600">Rs.@transaction.Debit.ToString("")</span>
                            }
                        </td>
                        <td class="border px-4 py-2">@transaction.Date.ToString("MM/dd/yyyy")</td>
                        <td class="border px-4 py-2">@transaction.Description</td>
                        <td class="border px-4 py-2">@transaction.Tags</td>
                        <td class="border px-4 py-2">@transaction.AdditionalNotes</td>
                    </tr>
                }
            </tbody>

        </table>
    </div>

</div>

@code {
    private AppData Data;
    private decimal cashInflow;
    private decimal cashOutflow;
    private decimal totalDebt;
    private decimal clearedDebt;
    private decimal remainingDebt;
    private List<Debt> pendingDebts;
    private IEnumerable<Transactions> FilteredTransactions;
    private IEnumerable<string> AvailableTags;
    private string SelectedCategory = "All";
    private string SelectedTag = "All";
    private string SelectedDateFilter = "All";
    private string SearchQuery = "";
    private DateTime? StartDate;
    private DateTime? EndDate;
    private decimal MainBalance;
    private Transactions HighestInflowTransaction;
    private Transactions HighestOutflowTransaction;
    private Transactions LowestInflowTransaction;
    private Transactions LowestOutflowTransaction;



    protected override void OnInitialized()
    {
        Data = UserService.LoadData();
        var transactions = Data.Transactions;

        // Fetching all transactions from AppData
        var debts = Data.Debt;


        totalDebt = debts.Sum(d => d.Amount);       // Total amount of all debts
        clearedDebt = debts.Sum(d => d.PaidAmount); // Total paid amount
        remainingDebt = totalDebt - clearedDebt;

        cashInflow = transactions.Sum(t => t.Credit) + remainingDebt - clearedDebt;
        cashOutflow = transactions.Sum(t => t.Debit) ;

        MainBalance = cashInflow - cashOutflow;

        if (Data != null && Data.Transactions != null)
        {
            AvailableTags = Data.Transactions
                .Where(t => t.Tags != null)
                .SelectMany(t => t.Tags.Split(','))
                .Distinct()
                .ToList();

            FilteredTransactions = Data.Transactions;
            CalculateHighestTransactions();

            ApplyFilters();
        }
        else
        {
            AvailableTags = new List<string>();
            CalculateHighestTransactions();

            FilteredTransactions = new List<Transactions>();
        }
    }
    private async Task DownloadTransactionsAsExcel()
    {
        var base64Data = await GetExcelBase64DataAsync();
        await JSRuntime.InvokeVoidAsync("saveAsFile", "Transaction_history.xlsx", base64Data);
    }

    private async Task<string> GetExcelBase64DataAsync()
    {
        var transactions = FilteredTransactions;
        var package = new OfficeOpenXml.ExcelPackage();
        var worksheet = package.Workbook.Worksheets.Add("Transactions");

        worksheet.Cells[1, 1].Value = "Transaction ID";
        worksheet.Cells[1, 2].Value = "Source/Purpose";
        worksheet.Cells[1, 3].Value = "Credit";
        worksheet.Cells[1, 4].Value = "Debit";
        worksheet.Cells[1, 5].Value = "Date";
        worksheet.Cells[1, 6].Value = "Tags";

        int row = 2;
        foreach (var transaction in transactions)
        {
            worksheet.Cells[row, 1].Value = "#TRNSC00-" + transaction.Id;
            worksheet.Cells[row, 2].Value = transaction.Description;
            worksheet.Cells[row, 3].Value = transaction.Credit;
            worksheet.Cells[row, 4].Value = transaction.Debit;
            worksheet.Cells[row, 5].Value = transaction.Date.ToString("MM/dd/yyyy");
            worksheet.Cells[row, 6].Value = transaction.Tags;
            row++;
        }

        var fileData = package.GetAsByteArray();
        return Convert.ToBase64String(fileData);
    }
    private void CalculateHighestTransactions()
    {
        // Highest Inflow Transaction
        HighestInflowTransaction = FilteredTransactions
            .Where(t => t.Credit > 0 )
            .OrderByDescending(t => t.Credit)
            .FirstOrDefault();

        // Lowest Inflow Transaction
        LowestInflowTransaction = FilteredTransactions
            .Where(t => t.Credit > 0)
            .OrderBy(t => t.Credit)
            .FirstOrDefault();

        // Highest Outflow Transaction
        HighestOutflowTransaction = FilteredTransactions
            .Where(t => t.Debit > 0)
            .OrderByDescending(t => t.Debit)
            .FirstOrDefault();

        // Lowest Outflow Transaction
        LowestOutflowTransaction = FilteredTransactions
            .Where(t => t.Debit > 0)
            .OrderBy(t => t.Debit)
            .FirstOrDefault();
    }
    private void FilterByCategory(ChangeEventArgs e)
    {
        SelectedCategory = e.Value.ToString();
        ApplyFilters();
    }

    private void FilterByTag(ChangeEventArgs e)
    {
        SelectedTag = e.Value.ToString();
        ApplyFilters();
    }

    private void FilterByDate(ChangeEventArgs e)
    {
        SelectedDateFilter = e.Value.ToString();
        ApplyFilters();
    }

    private void SearchTransactions(ChangeEventArgs e)
    {
        SearchQuery = e.Value.ToString();
        ApplyFilters();
    }

    private void UpdateStartDate(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var date))
        {
            StartDate = date;
            ApplyFilters();
        }
    }

    private void UpdateEndDate(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var date))
        {
            EndDate = date;
            ApplyFilters();
        }
    }

    private void SortByLatest()
    {
        FilteredTransactions = FilteredTransactions.OrderByDescending(t => t.Date);
    }

    private void SortByOldest()
    {
        FilteredTransactions = FilteredTransactions.OrderBy(t => t.Date);
    }

    private void ApplyFilters()
    {
        FilteredTransactions = Data.Transactions;

        if (SelectedCategory != "All")
        {
            FilteredTransactions = SelectedCategory == "Credit"
                ? FilteredTransactions.Where(t => t.Credit > 0)
                : FilteredTransactions.Where(t => t.Debit > 0);
        }

        if (SelectedTag != "All")
        {
            FilteredTransactions = FilteredTransactions.Where(t => t.Tags.Contains(SelectedTag));
        }

        if (SelectedDateFilter == "LastMonth")
        {
            var lastMonth = DateTime.Now.AddMonths(-1);
            FilteredTransactions = FilteredTransactions.Where(t => t.Date >= lastMonth);
        }
        else  if (SelectedDateFilter == "Last3Months")
        {
            var last3Months = DateTime.Now.AddMonths(-3);
            FilteredTransactions = FilteredTransactions.Where(t => t.Date >= last3Months);
        }
        else if (SelectedDateFilter == "SpecificRange")
        {
            if (StartDate.HasValue)
            {
                FilteredTransactions = FilteredTransactions.Where(t => t.Date >= StartDate.Value);
            }

            if (EndDate.HasValue)
            {
                FilteredTransactions = FilteredTransactions.Where(t => t.Date <= EndDate.Value);
            }
        }

        if (!string.IsNullOrWhiteSpace(SearchQuery))
        {
            FilteredTransactions = FilteredTransactions.Where(t =>
                t.Description.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase) ||
                t.Tags.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase) ||
                (t.Credit > 0 && "Credit".Contains(SearchQuery, StringComparison.OrdinalIgnoreCase)) ||
                (t.Debit > 0 && "Debit".Contains(SearchQuery, StringComparison.OrdinalIgnoreCase))
            );
        }
    }
}

